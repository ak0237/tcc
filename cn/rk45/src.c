#include <stdio.h>
#include <math.h>

#define BETA 0.05
#define GAMA 0.01

double S(double i, double s, double n){
    return -(BETA*i*s)/n;
}

double I(double i, double s, double n){
    return ((BETA*i*s)/n) - GAMA*i;
}

double R(double i){
    return GAMA*i;
}

int main(){
    double k1, k2, k3, k4, k5, k6, l1, l2, l3, l4, l5, l6, m1, m2, m3, m4, m5, m6;
    double epslon, i, s, r, n;
    double  i4, i5, s4, s5, r4, r5,  h=0.1, t=0.0, tf = 500.0, e;
    int c = 0, cmax = 100000000;

    double hmin = 0.01, hmax = 0.1, emin = 1e-6, emax = 1e-3;

    n=500.0;
    s = s5 = s4= 199.0;
    i = i5 = i4= 1.0;
    r = r5 = r4= 300.0;



    //epslon = 1e-5;



    FILE *file = fopen("dat/sir_rk45.dat", "w");

    fprintf(file, "%e %e %e %e \n", t, s, i, r);

    while(t < tf && c < cmax){
       // printf("%e\n", t);
        if(h < hmin)
            h = hmin;
        if(h > hmax)
            h = hmax;

        // Ajustar o passo no último intervalo para não ultrapassar tf
        if (t + h > tf) {
            h = tf - t;
        }

        k1 = S( i, s, n);
        l1 = I( i, s, n);
        m1 = R( i);

        k2 = S( i+h*(1.0/4.0)*l1, s+h*(1.0/4.0)*k1, n);
        l2 = I( i+h*(1.0/4.0)*l1, s+h*(1.0/4.0)*k1, n);
        m2 = R( i+h*(1.0/4.0)*l1);
        
        k3 = S( i+(3.0/32.0) * h * l1 + h*(9.0/32.0)*l2, s + (3.0/32.0) * h * k1 + h * (9.0/32.0) * k2, n);
        l3 = I( i+(3.0/32.0) * h * l1 + h*(9.0/32.0)*l2, s + (3.0/32.0) * h * k1 + h * (9.0/32.0) * k2, n);
        m3 = R( i+(3.0/32.0) * h * l1 + h*(9.0/32.0)*l2);

        k4 = S( i+ (1932.0/2197.0) * h * l1 - (7200.0/2197.0) * h * l2 + (7296.0/2197.0) * h * l3, s+(1932.0/2197.0) * h * k1 - (7200.0/2197.0) * h * k2 + (7296.0/2197.0) * h * k3, n);
        l4 = I( i+ (1932.0/2197.0) * h * l1 - (7200.0/2197.0) * h * l2 + (7296.0/2197.0) * h * l3, s+(1932.0/2197.0) * h * k1 - (7200.0/2197.0) * h * k2 + (7296.0/2197.0) * h * k3, n);
        m4 = R( i+ (1932.0/2197.0) * h * l1 - (7200.0/2197.0) * h * l2 + (7296.0/2197.0) * h * l3);

        k5 = S( i + (439.0/216.0) * h * l1 - 8.0 * h * l2 + (3680.0/513.0) * h * l3 - (845.0/4104.0) * h * l4, s + (439.0/216.0) * h * k1 - 8.0 * h * k2 + (3680.0/513.0) * h * k3 - (845.0/4104.0) * h * k4, n);
        l5 = I( i + (439.0/216.0) * h * l1 - 8.0 * h * l2 + (3680.0/513.0) * h * l3 - (845.0/4104.0) * h * l4, s + (439.0/216.0) * h * k1 - 8.0 * h * k2 + (3680.0/513.0) * h * k3 - (845.0/4104.0) * h * k4, n);
        m5 = R( i + (439.0/216.0) * h * l1 - 8.0 * h * l2 + (3680.0/513.0) * h * l3 - (845.0/4104.0) * h * l4);

        k6 = S( i - (8.0/27.0) * h * l1 + 2.0 * h * l2 - (3544.0/2565.0) * h * l3 + (1859.0/4104.0) * h * l4 - (11.0/40.0) * h * l5, s - (8.0/27.0) * h * k1 + 2.0 * h * k2 - (3544.0/2565.0) * h * k3 + (1859.0/4104.0) * h * k4 - (11.0/40.0) * h * k5, n);
        l6 = I( i - (8.0/27.0) * h * l1 + 2.0 * h * l2 - (3544.0/2565.0) * h * l3 + (1859.0/4104.0) * h * l4 - (11.0/40.0) * h * l5, s - (8.0/27.0) * h * k1 + 2.0 * h * k2 - (3544.0/2565.0) * h * k3 + (1859.0/4104.0) * h * k4 - (11.0/40.0) * h * k5, n);
        m6 = R( i - (8.0/27.0) * h * l1 + 2.0 * h * l2 - (3544.0/2565.0) * h * l3 + (1859.0/4104.0) * h * l4 - (11.0/40.0) * h * l5);

        // rk4

        s4 += h*((25.0/216.0) * k1 + (1408.0/2565.0) * k3 + (2197.0/4104.0) * k4 - (1.0/5.0) * k5); 
        i4 += h*((25.0/216.0) * l1 + (1408.0/2565.0) * l3 + (2197.0/4104.0) * l4 - (1.0/5.0) * l5); 
        r4 += h*((25.0/216.0) * m1 + (1408.0/2565.0) * m3 + (2197.0/4104.0) * m4 - (1.0/5.0) * m5); 

        // rk45

        s5 += h*((16.0/135.0) * k1 + (6656.0/12825.0) * k3 + (28561.0/56430.0) * k4 - (9.0/50.0) * k5 + (2.0/55.0) * k6);
        i5 += h*((16.0/135.0) * l1 + (6656.0/12825.0) * l3 + (28561.0/56430.0) * l4 - (9.0/50.0) * l5 + (2.0/55.0) * l6);
        r5 += h*((16.0/135.0) * m1 + (6656.0/12825.0) * m3 + (28561.0/56430.0) * m4 - (9.0/50.0) * m5 + (2.0/55.0) * m6);

        e = fmax(fmax(fabs(s4 - s5) / fmax(s, 1e-10), fabs(i4 - i5) / fmax(i, 1e-10)), fabs(r4 - r5) / fmax(r, 1e-10));

        if(e > emax && h > hmin){
            h = 0.5 * h;
        }else{
            s = s5;
            i = i5;
            r = r5;
            t +=h;

            fprintf(file, "%e %e %e %e \n", t, s, i, r);

            if(e < emin)
                h = 2 * h;
            
            c++;
        }

       
        
    }

    fclose(file);

    return 0;

}
